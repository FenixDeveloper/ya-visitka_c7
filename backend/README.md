# Проект **«Визитница»** (backend)

## Краткое описание проекта

**API для платформы-визитницы** (внутреннего сервиса Яндекс.Практикум, где студенты могут публиковать свои визитки, давать обратную связь (реакции, комментарии) и изучать визитки друг друга. Для бэкенда используется **Node.js** с **TypeScript** и библиотеки **Express**, **Mongoose**, **Passport.js**. Для хранения данных на бэкенде используется база данных **MongoDB**. Для загрузки файлов использутся **multer**. В проекте имеется **2 роли:** куратор и студент.

## Бриф

Ссылка на [БРИФ](https://concrete-web-bad.notion.site/3-7-32283a40b8fa4027b0b7ef0f6ef8b1a7) в notion.

## Описание API сервиса

## Оглавление

- [Роуты:](#routes)
  - [Авторизация](#auth)
  - [Пользователи](#users)
  - [Комментарии](#comments)
  - [Файлы](#files)
  - [Профили](#profiles)
  - [Реакции](#reactions)
  - [Проверка подключения](#check)
- [Инструкция по запуску проекта](#installation)
- [Ссылки:](#links)
  - [Swagger](#swagger)
  - [Postman](#postman)
  - [Frontend](#frontend)
  - [Доступ к приложению](#deploy)


## <a id="routes" /> Роуты:

### <a id="auth" /> Авторизация

 `/api/auth`

**Назначение**: Роут для авторизации и получения access-token

**Метод**: POST

 **Принимает**: code (строка). Роут не защищен авторизацией

**Результат**: При ошибке отправялет объект ошибки с полем error. При успешной регистрации отправляет access-token.


### <a id="users" /> Пользователи

`/api/users/me`

**Назначение**: Роут для получения юзера

**Метод**: GET

**Принимает**: авторизационный токен

**Результат**:
- объект:
  - для студента: _id, name, email, cohort, photo, role
  - для куратора: - email, role


`api/users`

**Назначение**: Создает студента

**Метод**: POST

**Принимает**: body: (email, cohort)

**Результат**: Проверяет уникальность почты и Создает запись нового студента по данным из запроса, отправляет созданную запись


`api/users`

**Назначение**: роут для получения списка студентов

**Метод**: GET

**Принимает**:
- Query параметры:
  - offset - число, указывает, сколько комментариев необходимо пропустить
  - limit - число, сколько комментарив необходимо показать 
  - search - строка, фильтр записей по полям email, cohort, name

**Результат**: Отправляет объект со счетчиком общего количества записей и массивом полученных пользователей.


`api/users/:id`

**Назначение**: Роут для обновления данных студента

**Метод**: PUT

**Принимает**: body: (email, cohort)

**Результат**: Проверяет уникальность почты и обновляет запись студента по данным из запроса, отправляет объект с обновленными данными.


### <a id="comments" /> Комментарии

`api/comments`

**Назначение**: Получение куратором комментриев студентов.

**Метод**: GET

**Принимает**:
- Query параметры:
  - offset - число, указывает, сколько комментариев необходимо пропустить
  - limit - число, сколько комментарив необходимо показать 
  - search - строка, фильтр записей по полям email, cohort, name
-  авторизационный токен

**Результат**:
- Объект:
  - items - массив объектов, представляющих собой комментрии пользователей заданной структуры
  - total - количество объектов в массиве реакций


`api/comments/:id`

**Назначение**: Удаление комментария студента по id.

**Метод**: DELETE

**Принимает**:
- params: id реакции (строка)
- авторизационный токен

**Результат**: При успешном удалении комментария отправляет статус 200

### <a id="files" /> Файлы


`api/files`

**Назначение**: Получение и локальное сохранение файлов пользователя

**Метод**: POST

**Принимает**: 
- files - файлы, отправленные пользователем. значение поля name формы отправки файлов было 
одним из 'hobby' | 'status' | 'job' | 'education' | 'avatar'.
- авторизационный токен

**Результат**: При успешном сохранении файлов, отправляет объект с именем сохраненных файлов.


`api/files/:filename`

**Назначение**: Скачивание сохраненных файлов пользователей.

**Метод**: GET

**Принимает**: 
- files - файлы, отправленные пользователем. Необходимо, чтобы значение поля name формы отправки файлов было одним из 'hobby' | 'status' | 'job' | 'education' | 'avatar'
- авторизационный токен

**Результат**: Отправлеяет файл с соответствующим именем


### <a id="profiles" /> Профили

`api/profiles`

**Назначение**: Получение профилей студентов

**Метод**: GET

**Принимает**:

- Query параметры:
  - offset - число, указывает, сколько комментариев необходимо пропустить
  - limit - число, сколько комментарив необходимо показать 
  - cohort - строка, фильтр для поиска записей по полю cohort
  
**Результат**: Отправляет объект со счетчиком общего количества записей и массивом полученных профилей.


`api/profiles/:id`


**Назначение**: Получение профиля студента с соответствующим id

**Метод**: GET

**Принимает**:
- params: id профиля (строка).
- авторизационный токен.

**Результат**: При успешном запросе, отправляет объект с данными профиля


`api/profiles/:id`

**Назначение**: обновление профиля студента с соответствующим id

**Метод**: PATCH

**Принимает**:
- params: id профиля (строка).
- авторизационный токен.
- body - объект соответствующий типу IUser

**Результат**: При успешном обновлении данных профиля, отправляет объект с обновленными данными


### <a id="reactions" /> Реакции

`api/profiles/:id/reactions`

**Назначение**: Добавление реакции к профилю студента

**Метод**: POST

**Принимает**:

- Query параметры:
  - offset - число, указывает, сколько реакций необходимо пропустить
  - limit - число, сколько реакций необходимо показать 
- params: id профиля (строка)
- body:
  - target - ключ из поля profile.info или null для профиля
  - text - "string",  если это комментарий
  - emotion - "string", если это эмоция
  
**Результат**: При успешном добавлении реакции отправляет статус 200.


`api/profiles/:id/reactions`

**Назначение**: Получение реакций профиля

**Метод**: GET

**Принимает**:
- Query параметры:
  - offset - число, указывает, сколько реакций необходимо пропустить
  - limit - число, сколько реакций необходимо показать 
- params: id профиля (строка)

**Результат**: Отправляет объект со счетчиком общего количества записей и массивом полученных реакций.


### <a id="check" /> Проверка подключения

`api/healthcheck`

**Назначение**: Проверяет подключение к серверу.

**Метод**: GET

***Результат**: Статус подключения сервера

## <a id="installation" /> Инструкция по запуску проекта:

**Требования к окружению**:
* **Node.js** (не старше **15.x**)
* **MongoDB** и создать на сервере базу данных **MogoDB** сименем **visitka**
* В случае запуска проекта через систему докерезации - **Docker** и **docker compose**

**Конфигурационные параметры, которые необходимо задать**:
* **DB_URL** - путь до базы данных
* **JWT_SECRET** - секрет для генерации JWT токенов
* **PORT** - порт для запуска приложения
* **CLIENT_ID** - идентификатор клиента, зарегистрированный в Yandex Passport
* **CLIENT_SECRET** - секретный ключ, полученный при регистрации приложения в Yandex Passport
* **CURATOR_LIST** - строка с почтами кураторов, через которые можно получить доступ к административной части api

Заполнение конфигурационных параметров осуществляется в файле .env. Пример заполнения продемонстрирован в файле [.env.example](./.env.example). Для регистрациии, как куратор необходимо в CURATOR_LIST добавить свою почту.

### Запуск проекта

* Склонировать репозиторий
```bash
git clone https://github.com/FenixDeveloper/ya-visitka_c7.git
```

* Перейти в папку с проектном
```bash
cd ya-visitka_c7/backend
```

* Перейти в ветку develop
```bash
git checkout develop
```

* Установить зависимости
```bash
npm install
```
* Добавить файл .env, заполнить по образцу файла .env.example

* Запустить проект - npm start, либо в корневой дирректории выполнить команду sudo docker compose up - что развернет контейнер с приложением и базой данных

## <a id="links" /> Ссылки:

### <a id="swagger" /> Swagger

В корне проекта находится файл с описанием Open API: visitka-schema.yaml. Его можно использовать для загрузки в [Swagger](https://editor.swagger.io/)


### <a id="postman" /> Users Коллекция Postman

Ссылка на [Коллекцию Postman](https://www.postman.com/geniav/workspace/visitki-api/collection/24756620-d13d8ad5-7a0e-448a-b24e-3af989df84e7?action=share&creator=247566206), которую можно использовать для тестирования API. Для того, чтобы **войти в приложение, как куратор**, необходимо, чтобы email куратора был внесен в список CURATOR_LIST (.env-файл или при локальном тестировании и отсутствии .env-файла занести в файл config.ts). После необходимо пройти по [ссылке](https://oauth.yandex.ru/authorize?response_type=code&client_id=6588f39ea0274d599d3c60fb10c53556) и авторизоваться в яндеке. После авторизации произойдет переадресация. В адресной строке появится параметр code, который необходимо использовать в теле PORT-запроса /api/auth в Postman для получения access-token. Полученный токен использовать для дальнейшей работы с API. Для того, чтобы **зайти в приложение в роли студента**, необходимо, чтобы студент был в базе (студенты добавляются куратором). Далее схема авторизации аналогична куратору

### <a id="frontend" /> Frontend

Ссылка на [папку c frontend](https://github.com/FenixDeveloper/ya-visitka_c7/tree/develop/frontend).

### <a id="deploy" />  Доступ к приложению

**Frontend:** https://visitki-dev.team-7.practicum-team.ru

**Backend:** https://visitki-dev.team-7.practicum-team.ru/api/

