# Проект **«Визитница»** (backend)

## Краткое описание проекта

**API для платформы-визитницы** (внутреннего сервиса Яндекс.Практикум, где студенты могут публиковать свои визитки, давать обратную связь (реакции, комментарии) и изучать визитки друг друга. Для бэкенда используется **Node.js** с **TypeScript** и библиотеки **Express**, **Mongoose**, **Passport.js**. Для хранения данных на бэкенде используется база данных **MongoDB**. Для загрузки файлов использутся **multer**. В проекте имеется **2 роли:** куратор и студент.

## Бриф

Ссылка на [БРИФ](https://concrete-web-bad.notion.site/3-7-32283a40b8fa4027b0b7ef0f6ef8b1a7) в notion.

## Описание API сервиса

`/api/auth`

**Назначение**: Роут для авторизации и получения access-token.

**Метод**: POST

На вход принимает **code** (строку). Роут не защищен авторизацией. При ошибке отправялет объект ошибки с полем error. При успешной регистрации отправляет **access-token**.

`/api/users/me`

**Назначение**: Роут для получения юзера.

**Метод**: GET

В заголовке Authorization передается **токен**, роут защищен авторизацией. Отдает **объект** с полями:
**студент** - _id, name, email, cohort, photo, role.
**куратор** - email, role.
При ошибке отправялет объект ошибки с полем error.

`api/users`

**Назначение**: Создает студента

**Метод**: POST

Создает запись нового студента по данным из запроса

`api/users`

**Назначение**: роут для получения списка студентов

**Метод**: GET

Результатом запроса является объект со счетчиком общего количества записей и массивом полученных пользователей.

На вход принимает следующие query-параметры:
<ul>
  <li> offset: задает кол-во записей которые будут пропущены</li>
  <li> limit: максимальное кол-во записей </li>
  <li> search: параметр дял поиска записей по полям email, cohort, name</li>
</ul>


`api/users/:id`

**Назначение**: Роут для обновления данных студента

**Метод**: PUT

Обновляет email и когорту по данным из запроса


`api/comments`

**Назначение**: Получение куратором комментриев студентов.

**Метод**: GET

На вход принимает Query-параметры: **offset** (число, указывает, сколько комментрие необходимо пропустить), **limit** (число, сколько комментрив необходимо показать), **search** (строка, фильтр по Фамилии и Имени студента/его когорте/ email). В заголовке Authorization передается **токен**, т.к. роут защищен авторизацией. Отдает **объект** с 2-мя полями: **items -** массив объектов, представляющих собой комментрий пользователя заданной структуры, **total -** количество объектов в массиве реакций).


`api/comments/:id`

**Назначение**: Удаление комментрия студента по id.

**Метод**: DELETE

На вход принимает **id** реакции (строку). В заголовке Authorization передается **токен**, т.к. роут защищен авторизацией. При ошибке отправялет объект ошибки с полем error. При успешном удалении комментария отправляет **статус 200**.


`api/files`

**Назначение**: Получение и локальное сохранение файлов пользователя.

**Метод**: POST

На вход принимает **files** файлы, отправленные пользователем. Необходимо, чтобы значение поля **name** формы отправки файлов было одним из **'hobby' | 'status' | 'job' | 'education' | 'avatar'**. В заголовке Authorization передается **токен**, т.к. роут защищен авторизацией. При ошибке отправляет объект ошибки с полем error. При успешном сохранении файлов, отправляет **объект** с именем сохраненных файлов.


`api/files/:filename`

**Назначение**: Скачивание сохраненных файлов пользователей.

**Метод**: GET

На вход принимает имя файла **filename** (строку). В заголовке Authorization передается **токен**, т.к. роут защищен авторизацией. При ошибке отправляет объект ошибки с полем error. При наличии файла с таким именем, файл отправляется.

`api/profiles`

**Назначение**: Получение профилей студентов

**Метод**: GET

В качестве query параметров принимает:
<ul>
  <li> offset: задает кол-во записей которые будут пропущены</li>
  <li> limit: максимальное кол-во записей </li>
  <li> cohort: параметр дял поиска записей по полю cohort</li>
</ul>

`api/profiles/:id`

**Назначение**: Получение профиля студента с соответствующим id

**Метод**: GET

В заголовке Authorization передается **токен**, т.к. роут защищен авторизацией. При ошибке отправялет объект ошибки с полем error. При успешном удалении комментария отправляет **статус 200**.


`api/profiles/:id`

**Назначение**: Обновление профиля студента с соответствующим id

**Метод**: PATCH

В качестве тела запроса передается объект соответствующий типу IUser

В заголовке Authorization передается **токен**, т.к. роут защищен авторизацией. При ошибке отправялет объект ошибки с полем error. При успешном удалении комментария отправляет **статус 200**.

`api/profiles/:id`

**Назначение**:

**Метод**: POST


`api/profiles/:id/reactions`

**Назначение**: Добавляет реакцию к профилю студента
- Query - параматры **limit** и **offset**; не обязательные; по дефолту **limit = 20**, **offset = 0**
- Params - **id** целевого профиля;
- body - ```{
              target: ключ из поля profile.info или null для профиля,
              "text": "string",  если это комментарий,
              "emotion":"string", если это эмоция
            }```

**Метод**: POST


`api/profiles/:id/reactions`

**Назначение**: Получение реакций профиля
- Query - параматры **limit** и **offset**; не обязательные; по дефолту **limit = 20**, **offset = 0**
- Params - **id** целевого профиля;
**Метод**: GET


`api/healthcheck`

**Назначение**: Запрос предназначен для проверки подключения сервера.

**Метод**: GET

## Ссылка на Swagger

В корне проекта находится файл с описанием Open API: visitka-schema.yaml. Его можно использовать для загрузки в [Swagger](https://editor.swagger.io/)


## Коллекция Postman

Ссылка на [Коллекцию Postman](https://www.postman.com/geniav/workspace/visitki-api/collection/24756620-d13d8ad5-7a0e-448a-b24e-3af989df84e7?action=share&creator=247566206), которую можно использовать для тестирования API. Для того, чтобы **войти в приложение, как куратор**, необходимо, чтобы email куратора был внесен в список CURATOR_LIST (.env-файл или при локальном тестировании и отсутствии .env-файла занести в файл config.ts). После необходимо пройти по [ссылке](https://oauth.yandex.ru/authorize?response_type=code&client_id=6588f39ea0274d599d3c60fb10c53556) и авторизоваться в яндеке. После авторизации произойдет переадресация. В адресной строке появится параметр code, который необходимо использовать в теле PORT-запроса /api/auth в Postman для получения access-token. Полученный токен использовать для дальнейшей работы с API. Для того, чтобы **зайти в приложение в роли студента**, необходимо, чтобы студент был в базе (студенты добавляются куратором). Далее схема авторизации аналогична куратору


## Инструкция по запуску проекта

**Требования к окружению**:
* **Node.js** (не старше **15.x**)
* **MongoDB** и создать на сервере базу данных **MogoDB** сименем **visitka**
* В случае запуска проекта через систему докерезации - **Docker** и **docker compose**

**Конфигурационные параметры, которые необходимо задать**:
* **DB_URL** - путь до базы данных
* **JWT_SECRET** - секрет для генерации JWT токенов
* **PORT** - порт для запуска приложения
* **CLIENT_ID** - идентификатор клиента, зарегистрированный в Yandex Passport
* **CLIENT_SECRET** - секретный ключ, полученный при регистрации приложения в Yandex Passport
* **CURATOR_LIST** - строка с почтами кураторов, через которые можно получить доступ к административной части api

Заполнение конфигурационных параметров осуществляется в файле .env. Пример заполнения продемонстрирован в файле [.env.example](./.env.example). Для регистрациии, как куратор необходимо в CURATOR_LIST добавить свою почту.

## Запуск проекта

* Склонировать репозиторий
```bash
git clone https://github.com/FenixDeveloper/ya-visitka_c7.git
```

* Перейти в папку с проектном
```bash
cd ya-visitka_c7/backend
```

* Перейти в ветку develop
```bash
git checkout develop
```

* Установить зависимости
```bash
npm install
```
* Добавить файл .env, заполнить по образцу файла .env.example

* Запустить проект - npm start, либо в корневой дирректории выполнить команду sudo docker compose up - что развернет контейнер с приложением и базой данных

## Frontend

Ссылка на [папку c frontend](https://github.com/FenixDeveloper/ya-visitka_c7/tree/develop/frontend).

## Доступ к приложению

**Frontend:** https://visitki-dev.team-7.practicum-team.ru

**Backend:** https://visitki-dev.team-7.practicum-team.ru/api/

